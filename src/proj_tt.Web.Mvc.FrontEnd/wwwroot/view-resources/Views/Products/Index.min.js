(function(n){function e(){n("#ProductionDateRange").daterangepicker({autoUpdateInput:!1,locale:{cancelLabel:"Clear"}});n("#ProductionDateRange").on("apply.daterangepicker",function(t,r){n(this).val(r.startDate.format("MM/DD/YYYY")+" - "+r.endDate.format("MM/DD/YYYY"));i()});n("#ProductionDateRange").on("cancel.daterangepicker",function(){n(this).val("");i()});n("#SearchTerm").on("keyup",l(function(){i()},500));n("#MinPrice, #MaxPrice").on("change",function(){i()});r.getAllCategories().done(function(r){var u=`
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="category" id="cat_all" value="" checked>
                    <label class="form-check-label" for="cat_all">${t("AllCategories")}</label>
                </div>`;r.forEach(function(n){u+=`
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="category" id="cat_${n.id}" value="${n.id}">
                        <label class="form-check-label" for="cat_${n.id}">${n.name}</label>
                    </div>`});n("#CategoryList").html(u);n('input[name="category"]').on("change",function(){i()})});n("#priceRange").ionRangeSlider({type:"double",min:0,max:2e12,from:0,to:2e12,step:1e6,grid:!0,prefix:"VND ",onFinish:function(t){n("#MinPriceInput").val(t.from);n("#MaxPriceInput").val(t.to);i()}});n("#CategoryDropdownEdit").select2({placeholder:t("SelectCategory"),allowClear:!0,width:"100%"});n("#CategoryDropdownEdit").on("change",function(){i()});n("#MinPriceInput, #MaxPriceInput").on("change",function(){var t=parseInt(n("#MinPriceInput").val())||0,r=parseInt(n("#MaxPriceInput").val())||2e12;n("#priceRange").data("ionRangeSlider").update({from:t,to:r});i()})}function i(){var t={searchTerm:n("#SearchTerm").val(),minPrice:n("#MinPrice").val(),maxPrice:n("#MaxPrice").val(),categoryId:n('input[name="category"]:checked').val(),productionDateRange:n("#ProductionDateRange").val()};r.getProductPaged(n.extend({},t,{skipCount:(currentPage-1)*pageSize,maxResultCount:pageSize})).done(function(n){currentView==="grid"?o(n.items):s(n.items);h(n.totalCount)})}function o(n){var t="";n.forEach(function(n){t+=`
<div class="col">
    <div class="card h-100 product-card">
        <div class="position-relative">
            <img src="${n.imageUrl}" class="card-img-top" alt="${n.name}" 
                 onerror="this.src='https://placehold.co/300x300?text=Image+Not+Found'">
            ${n.discount>0?`<span class="badge bg-danger position-absolute top-0 start-0 m-2">-${n.discount}%</span>`:""}
            <div class="position-absolute top-0 end-0 m-2">
                ${f(n)}
            </div>
        </div>
        <div class="card-body">
            <h6 class="card-title text-truncate mb-2">${n.name}</h6>
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span class="fw-bold text-primary">$${(n.price*(1-n.discount/100)).toFixed(2)}</span>
                    ${n.discount>0?`<small class="text-muted text-decoration-line-through ms-2">$${n.price}</small>`:""}
                </div>
                <small class="text-muted">${n.categoryName}</small>
            </div>
        </div>
    </div>
</div>`});_$grid.html(t).removeClass("d-none");_$table.addClass("d-none")}function s(n){var t="";n.forEach(function(n){t+=`
<tr>
    <td>
        <img src="${n.imageUrl}" alt="${n.name}" style="width: 50px; height: 50px; object-fit: cover;"
             onerror="this.src='https://placehold.co/300x300?text=Image+Not+Found'">
    </td>
    <td>${n.name}</td>
    <td>
        <span class="fw-bold text-primary">$${(n.price*(1-n.discount/100)).toFixed(2)}</span>
        ${n.discount>0?`<small class="text-muted text-decoration-line-through d-block">$${n.price}</small>`:""}
    </td>
    <td>${n.discount}%</td>
    <td>${n.categoryName}</td>
    <td>${moment(n.productionDate).format("L")}</td>
    <td>${f(n)}</td>
</tr>`});_$table.find("tbody").html(t);_$table.removeClass("d-none");_$grid.addClass("d-none")}function f(n){var t='<div class="btn-group">';return u.edit&&(t+=`
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="editProduct(${n.id})">
                    <i class="fas fa-edit"></i>
                </button>`),u.delete&&(t+=`
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${n.id})">
                    <i class="fas fa-trash"></i>
                </button>`),t+"<\/div>"}function h(r){var e=Math.ceil(r/pageSize),f="",u;if(e>1){for(f+=`
                <li class="page-item ${currentPage===1?"disabled":""}">
                    <a class="page-link" href="#" data-page="${currentPage-1}">${t("Previous")}</a>
                </li>`,u=1;u<=e;u++)u===1||u===e||u>=currentPage-2&&u<=currentPage+2?f+=`
                        <li class="page-item ${u===currentPage?"active":""}">
                            <a class="page-link" href="#" data-page="${u}">${u}</a>
                        </li>`:(u===currentPage-3||u===currentPage+3)&&(f+='<li class="page-item disabled"><span class="page-link">...<\/span><\/li>');f+=`
                <li class="page-item ${currentPage===e?"disabled":""}">
                    <a class="page-link" href="#" data-page="${currentPage+1}">${t("Next")}</a>
                </li>`}n("#Pagination").html(f);n("#TotalCount").text(t("TotalXProducts",r));n("#Pagination .page-link").on("click",function(t){t.preventDefault();var r=n(this).data("page");r&&r!==currentPage&&(currentPage=r,i())})}function c(){n(".btn-group [data-view]").on("click",function(){n(".btn-group [data-view]").removeClass("active");n(this).addClass("active");currentView=n(this).data("view");i()})}function l(n,t){var i;return function(){var r=this,u=arguments;clearTimeout(i);i=setTimeout(function(){n.apply(r,u)},t)}}function a(t){const i=n(t);i.find("#image").on("change",function(){var t=this.files[0],n;t&&(n=new FileReader,n.onload=function(n){i.find("#imagePreview").attr("src",n.target.result).show()},n.readAsDataURL(this.files[0]))});i.on("hidden.bs.modal",function(){i.find("#imagePreview").attr("src","#").hide();i.find("#image").val("")})}var r=abp.services.app.product,t=abp.localization.getSource("proj_tt"),y=abp.localization.defaultSourceName,u,v;_$modal=n("#createModal");_$table=n("#ProductsTable");_$grid=n("#ProductsGrid");currentView="grid";currentPage=1;pageSize=15;u={create:abp.auth.isGranted("Pages.Products.Create"),edit:abp.auth.isGranted("Pages.Products.Edit"),"delete":abp.auth.isGranted("Pages.Products.Delete")};n(function(){e();i();c()});window.editProduct=function(t){abp.ajax({url:abp.appPath+"Product/EditModal?productId="+t,type:"GET",dataType:"html",success:function(t){n("#editModal div.modal-content").html(t)},error:function(){}})};window.deleteProduct=function(n){abp.message.confirm(t("ProductDeleteWarningMessage"),t("AreYouSure"),function(u){u&&r.delete(n).done(function(){abp.notify.success(t("SuccessfullyDeleted"));i()})})};_$form.validate({rules:{Name:{required:!0,minlength:3,maxlength:100},Price:{required:!0,number:!0,min:0,max:2e12},Discount:{number:!0,min:0,max:100},ImageUrl:{required:!0,imageExtension:!0,filesize:2097152},CategoryId:{required:!0}},messages:{Name:{required:t("ProductNameRequired"),minlength:t("PleaseEnterAtLeastNCharacter"),maxlength:t("PleaseEnterNoMoreThanNCharacter")},Price:{required:t("PriceRequired"),number:t("PriceMustBeNumber"),min:t("PriceMin"),max:t("PriceMax")},Discount:{number:t("DiscountMustBeNumber"),min:t("DiscountMin"),max:t("DiscountMax")},ImageUrl:{required:t("ImageRequired"),imageExtension:t("ImageExtensionInvalid"),filesize:t("ImageFilesizeMax")},CategoryId:{required:t("CategoryRequired")}}});n.validator.addMethod("filesize",function(n,t,i){return this.optional(t)||t.files[0].size<=i},"Dung lượng ảnh vượt quá giới hạn");n.validator.addMethod("imageExtension",function(n,t){if(t.files.length===0)return!1;var i=t.files[0].name;return/\.(jpe?g|png|gif|bmp|webp)$/i.test(i)},"Chỉ chấp nhận ảnh định dạng JPG, PNG, GIF, BMP");_$form.find(".save-button").on("click",r=>{if(r.preventDefault(),_$form.valid()){var f=_$form[0],u=new FormData(f);console.log("discount",u.get("Discount"));u.get("Discount")||u.set("Discount",0);abp.ui.setBusy(_$modal);n.ajax({url:abp.appPath+"Product/Create",type:"POST",data:u,processData:!1,contentType:!1,success:function(){_$modal.modal("hide");_$form[0].reset();abp.message.success(t("SuccessfullyRegistered"),t("Success"));i()},error:function(n){abp.notify.error("Thêm sản phẩm thất bại!");console.error(n)},complete:function(){abp.ui.clearBusy(_$modal)}})}});a("#createModal");flatpickr("#createModal #SelectedDate",{enableTime:!1,dateFormat:"Y-m-d",locale:"vi"});_$modal.on("shown.bs.modal",()=>{_$modal.find("input:not([type=hidden]):first").focus()}).on("hidden.bs.modal",()=>{_$form.clearForm()});n(".btn-search").on("click",()=>{i()});n(".btn-clear").on("click",()=>{n("#ProductionDateRange").val(""),n("#MinPriceInput").val(""),n("#MaxPriceInput").val(""),n("#CategoryDropdownEdit").val(null).trigger("change"),n("#priceRange").data("ionRangeSlider").update({from:0,to:2e12}),i()});v=_$table.DataTable({paging:!0,serverSide:!0,listAction:{ajaxFunction:r.getProductPaged,inputFilter:function(){var t=n("#ProductsSearchForm").serializeFormToObject(!0);return t.minPrice=n("#MinPriceInput").val(),t.maxPrice=n("#MaxPriceInput").val(),t.categoryId=n("#CategoryDropdownEdit").val(),t.productionDateRange=n("#ProductionDateRange").val(),console.log("Dữ liệu gửi đi:",t),t}}});n(".txt-search").on("keypress",n=>{if(n.which==13)return i(),!1})})(jQuery);